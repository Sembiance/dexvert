import {xu} from "xu";
import {fileUtil} from "xutil";
import {path, assertStrictEquals} from "std";
import {Program} from "../../src/Program.js";

export default async function buildPrograms()
{
	const programDirPath = path.join(xu.dirname(import.meta), "..", "..", "src", "program");
	xu.log1`Finding program JS files...`;
	const programFilePaths = await fileUtil.tree(programDirPath, {nodir : true, regex : /[^/]+\/.+\.js$/});
	xu.log1`Processing ${programFilePaths.length} program files...`;

	const relPaths = [];
	const programs = {};

	for(const programFilePath of programFilePaths)
	{
		// TODO REMOVE BELOW AFTER CONVERTING ALL PROGRAMS
		if(!(await fileUtil.readFile(programFilePath)).includes(" extends Program") || (await fileUtil.readFile(programFilePath)).startsWith("/*"))
			continue;
		// TODO REMOVE ABOVE AFTER CONVERTING ALL PROGRAMS

		const progamModule = await import(programFilePath);
		const programid = Object.keys(progamModule)[0];

		// class name must match filename
		assertStrictEquals(programid, path.basename(programFilePath, ".js"), `program file [${programFilePath}] does not have a matching class name [${programid}]`);

		// check for duplicates
		if(programs[programid])
			throw new Error(`program [${programid}] at ${programFilePath} is a duplicate of ${programs[programid]}`);

		// create the class and validate it
		programs[programid] = progamModule[programid].create();
		if(!(programs[programid] instanceof Program))
			throw new Error(`program [${programid}] at [${programFilePath}] is not of type Program`);
		
		relPaths.push([programid, path.relative(programDirPath, programFilePath)]);
	}

	xu.log1`Writing programs.js`;
	await fileUtil.writeFile(path.join(programDirPath, "programs.js"), `
	// DO NOT EDIT MANUALLY
	// AUTO GENERATED BY build/buildPrograms.js
	// DO NOT EDIT MANUALLY
	const programs = {};
	${relPaths.map(([programid, relPath]) => `import {${programid}} from "./${relPath}";\nprograms.${programid} = ${programid}.create(programs.${programid});`).join("\n")}
	export {programs};
	`);
}
